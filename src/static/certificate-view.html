<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الشهادة الصحية الموحدة</title>
    <link rel="stylesheet" href="certificate-view.css" />
</head>
<body>
    <!-- شريط العنوان العلوي -->
    <div class="top-bar">
        
        <div class="navigation-bar">
            <button class="back-btn" onclick="goBack()">←</button>
            <h1 id="page-title">--</h1>
            <div class="nav-actions">
                <button class="share-btn">📤</button>
                <button class="menu-btn">⋮</button>
            </div>
        </div>
    </div>

    <!-- الشهادة -->
    <div class="certificate-container">
        <div class="certificate-header">
            <div class="header-bg">
                <h2 class="certificate-title">الشهادة الصحية الموحدة</h2>
                <div class="logos">
                    <img src="assets/ministry_logo.png" alt="وزارة الشؤون البلدية" class="ministry-logo" />
                    <img src="assets/balady_logo.png" alt="بلدي" class="balady-logo" />
                </div>
            </div>
        </div>

        <div class="certificate-body">
            <div class="main-info-section">
                <!-- الصورة الشخصية + QR -->
                <div class="photo-qr-section">
                    <div class="profile-photo-container">
                        <img id="profile-image" src="https://via.placeholder.com/120x150?text=صورة" alt="الصورة الشخصية" class="profile-photo" />
                    </div>
                    <div class="qr-code-container">
                        <div id="qr-code" class="qr-code">
                            <div class="qr-placeholder">QR</div>
                        </div>
                    </div>
                </div>

                <!-- بيانات الشخص والشهادة -->
                <div class="person-data-section">
                    <div class="data-row">
                        <span class="field-value" id="full-name">--</span>
                    </div>

                    <div class="data-columns">
                        <div class="left-column">
                            <div class="data-field"><span class="field-label">الجنسية</span><span class="field-value" id="nationality">--</span></div>
                            <div class="data-field"><span class="field-label">السن</span><span class="field-value" id="age">--</span></div>
                            <div class="data-field"><span class="field-label">المهنة</span><span class="field-value" id="profession">--</span></div>
                            <div class="data-field"><span class="field-label">تاريخ نهاية الشهادة الصحية</span><span class="field-value" id="medical-expiry-date">--</span></div>
                            <div class="data-field"><span class="field-label">تاريخ انتهاء البرنامج التثقيفي</span><span class="field-value" id="educational-expiry-date">--</span></div>
                        </div>

                        <div class="right-column">
                            <div class="data-field"><span class="field-label">رقم الهوية</span><span class="field-value" id="identity-number">--</span></div>
                            <div class="data-field"><span class="field-label">رقم الشهادة الصحية</span><span class="field-value" id="certificate-number">--</span></div>
                            <div class="data-field"><span class="field-label">تاريخ إصدار الشهادة الصحية</span><span class="field-value" id="medical-issue-date">--</span></div>
                            <div class="data-field"><span class="field-label">نوع البرنامج التثقيفي</span><span class="field-value" id="educational-program-type">--</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- شريط الاتصال -->
            <div class="contact-info-bar">
                <div class="contact-item"><span class="contact-icon">📞</span><span class="contact-text">199040 رقم الطوارئ للبلدية</span></div>
                <div class="contact-item"><span class="contact-icon">🌐</span><span class="contact-text">Balady_cs</span></div>
                <div class="contact-item"><span class="contact-icon">📱</span><span class="contact-text">saudimomra</span></div>
                <div class="contact-item"><span class="contact-icon">🌐</span><span class="contact-text">www.balady.gov.sa</span></div>
            </div>
        </div>
    </div>

    <!-- تعليمات -->
    <div class="instructions-container">
        <div class="instructions-header">
            <div class="instructions-title">
                <span class="instructions-icon">⚠️</span>
                <h3>تعليمات وإرشادات</h3>
            </div>
            <div class="ministry-logos">
                <img src="assets/ministry_logo.png" alt="وزارة الشؤون البلدية" class="ministry-logo-small" />
                <img src="assets/balady_logo.png" alt="بلدي" class="balady-logo-small" />
            </div>
        </div>
        <div class="instructions-content">
            <div class="instruction-item"><span class="bullet">⭐</span><p>شهادة صحة تجدد سنوياً</p></div>
            <div class="instruction-item"><span class="bullet">⭐</span><p>يُسمح لحامل الشهادة الصحية بالعمل في منشآت الغذاء أو الصحة العامة وفق الجهة المسموح بها نظاماً</p></div>
            <div class="instruction-item"><span class="bullet">⭐</span><p>يلزم حامل هذه الشهادة بإجراء فحص طبي عند عودته من الخارج قبل البدء بممارسة العمل</p></div>
            <div class="instruction-item"><span class="bullet">⭐</span><p>لا تعتبر الشهادة إثبات هوية</p></div>
        </div>
    </div>

    <!-- نافذة طباعة -->
    <div id="print-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>خيارات الطباعة</h2>
                <span class="close" onclick="closePrintModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="print-options">
                    <div class="print-option" onclick="selectPrintOption('unified')">
                        <div class="option-icon">📄</div>
                        <div class="option-text">
                            <h3>شهادة موحدة</h3>
                            <p>طباعة الشهادة الصحية الموحدة الكاملة</p>
                        </div>
                    </div>
                    <div class="print-option" onclick="selectPrintOption('annual')">
                        <div class="option-icon">📅</div>
                        <div class="option-text">
                            <h3>شهادة سنوية</h3>
                            <p>طباعة الشهادة السنوية المبسطة</p>
                        </div>
                    </div>
                </div>
                <div id="city-selection" class="city-selection" style="display: none;">
                    <h3>اختر المدينة</h3>
                    <div class="cities-grid">
                        <div class="city-option" onclick="selectCity('الرياض')">الرياض</div>
                        <div class="city-option" onclick="selectCity('جدة')">جدة</div>
                        <div class="city-option" onclick="selectCity('الدمام')">الدمام</div>
                        <div class="city-option" onclick="selectCity('مكة المكرمة')">مكة المكرمة</div>
                        <div class="city-option" onclick="selectCity('المدينة المنورة')">المدينة المنورة</div>
                        <div class="city-option" onclick="selectCity('الطائف')">الطائف</div>
                        <div class="city-option" onclick="selectCity('أبها')">أبها</div>
                        <div class="city-option" onclick="selectCity('تبوك')">تبوك</div>
                        <div class="city-option" onclick="selectCity('حائل')">حائل</div>
                        <div class="city-option" onclick="selectCity('أخرى')">أخرى</div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="proceedToPrint()">طباعة الشهادة</button>
                        <button class="btn btn-secondary" onclick="closePrintModal()">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(window.location.search);
    const id   = params.get('id');
    const type = params.get('type');   // unified / annual
    const city = params.get('city');

    if (!id) {
        alert('رقم الشهادة غير موجود');
        return;
    }

    try {
        const res = await fetch(`/api/certificates/${id}`);
        const json = await res.json();
        const c = json.data;

        // ملء البيانات
        document.getElementById('page-title').textContent = c.name || '--';
        document.getElementById('full-name').textContent = c.name || '--';
        document.getElementById('nationality').textContent = c.nationality || '--';
        document.getElementById('age').textContent = c.age || '--';
        document.getElementById('profession').textContent = c.profession || '--';
        document.getElementById('identity-number').textContent = c.id_number || '--';
        document.getElementById('certificate-number').textContent = c.certificate_number || '--';
        document.getElementById('medical-issue-date').textContent = c.medical_certificate_issue_date || '--';
        document.getElementById('medical-expiry-date').textContent = c.medical_certificate_expiry_date || '--';
        document.getElementById('educational-program-type').textContent = c.educational_program_type || '--';
        document.getElementById('educational-expiry-date').textContent = c.educational_program_expiry_date || '--';

        // الصورة
        const img = document.getElementById('profile-image');
        img.src = c.personal_photo || 'https://via.placeholder.com/120x150?text=صورة';

        // QR
        document.getElementById('qr-code').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=125x125&data=${c.certificate_number || ''}" alt="QR">`;
    } catch (e) {
        console.error(e);
        alert('خطأ في تحميل البيانات');
    }
});

function closePrintModal() { document.getElementById('print-modal').style.display = 'none'; }
function selectPrintOption(type) { document.getElementById('city-selection').style.display = 'block'; }
function selectCity(city) {
    selectedCity = city;
    document.querySelectorAll('.city-option').forEach(o => o.classList.remove('selected'));
    event.target.classList.add('selected');
}
function proceedToPrint() {
    if (!selectedCity) return alert('اختر المدينة');
    window.print();
    closePrintModal();
}
function goBack() { history.back(); }
</script>

</body>
</html>
